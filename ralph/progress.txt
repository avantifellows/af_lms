# Ralph Progress Log
Started: Sun Feb 15 23:07:30 IST 2026

## Codebase Patterns
- **Client component tests**: Use `@testing-library/react` + `userEvent.setup()` for interactions
- **Email inputs**: `type="email"` inputs have no label-input `htmlFor`/`id` association; query with `document.querySelector('input[type="email"]')` instead of `getByRole("textbox", { name: /email/i })`
- **Debounce testing**: Use `vi.useFakeTimers({ shouldAdvanceTime: true })` + `userEvent.setup({ advanceTimers: vi.advanceTimersByTime })`, then `vi.advanceTimersByTime(delay)` wrapped in `act()`
- **Fetch mocking**: `vi.stubGlobal("fetch", mockFetch)` with `mockFetch = vi.fn()` in `beforeEach`
- **Pre-existing build failure**: `e2e/helpers/db.ts:152` has type error (`string | undefined` not assignable to `string`) — not caused by unit tests
- **Pre-existing lint errors**: 818 errors exist in codebase; new test files should lint clean individually with `npx eslint <file>`
- **AddUserModal props**: `{ user, regions, onClose, onSave }` — NOT `{ isOpen, onClose, onSave, editUser, currentUserEmail }` as PRD stated
- **Multiple selects**: Use `screen.getAllByRole("combobox")` and index to target specific `<select>` elements
- **PRD props often wrong**: Always read actual source component to get real props interface before writing tests
- **Duplicate text in table+modal**: When a component shows the same text in a table row AND a modal, use `getAllByText()` or scope queries with `within()` to avoid `getByText` failing on multiple matches
- **Stats card counts**: Use `within(card)` scoping to check stat values, since count numbers like "1" or "2" may appear multiple times on page
- **Mock child components**: Use `vi.mock("./ChildComponent", ...)` with stub that exposes `data-testid` + callback buttons to test parent integration cleanly
- **Window dialogs**: `vi.stubGlobal("alert", vi.fn())` + `vi.stubGlobal("confirm", vi.fn(() => true))` in `beforeEach` for components using `alert()`/`confirm()`
- **Date inputs without htmlFor**: `type="date"` inputs may lack `htmlFor`/`id` association; query with `document.querySelector('input[type="date"]')` instead of `getByLabelText("Date")`
- **Duplicate count badges**: When selecting topics changes a count badge and another chapter has the same count text, use `getAllByText()` and check `className` to distinguish blue (selected) vs gray (total) badges

---

## 2026-02-15T23:12 - US-001
Session: 6606318b-4916-45b2-a239-0ad1438f2162
- Implemented 52 unit tests for AddUserModal.tsx
- Files changed: `src/app/admin/users/AddUserModal.test.tsx` (new, 755 lines)
- Test coverage areas: create/edit mode rendering, level-based UI visibility (levels 1-4), debounced school search with fake timers, region selection, program ID validation (NVS-only warning, no-programs error), form submission (POST create / PATCH edit), error handling (API error, network error, non-Error thrown), close/cancel behavior, read-only toggle
- **Learnings for future iterations:**
  - The PRD acceptance criteria listed incorrect props (`isOpen`, `editUser`, `currentUserEmail`) — always read the actual source component before writing tests
  - `input[type="email"]` is not accessible by role+name in jsdom because the `<label>` lacks `htmlFor`/`id` pairing — use `document.querySelector` instead
  - `vi.useFakeTimers({ shouldAdvanceTime: true })` is essential for debounce-within-useEffect testing, combined with `userEvent.setup({ advanceTimers: vi.advanceTimersByTime })`
  - The build (`npm run build`) has a pre-existing TS error in `e2e/helpers/db.ts:152` — this is NOT caused by unit test work
---

## 2026-02-15T23:15 - US-002
Session: 954bc1e7-5d57-458b-b0d3-080836a54cbf
- Implemented 26 unit tests for BatchList.tsx
- Files changed: `src/app/admin/batches/BatchList.test.tsx` (new, 482 lines)
- Test coverage areas: initial rendering (program selector, batch names/IDs, stream/grade labels, "Not set" badges, Edit buttons), empty state, program change (fetch new batches, loading state, fetch failure, network error), edit mode (enter, pre-fill stream/grade, defaults for null metadata, cancel), save edit (successful save, partial metadata, saving state, server error with message, generic error, network error, error clearing on re-edit), unknown stream fallback
- **Learnings for future iterations:**
  - BatchList props are `{ initialBatches, programs, initialProgramId }` — NOT `{ initialBatches, dbServiceUrl, dbServiceToken }` as PRD stated
  - When a component has multiple `<select>` elements, use `screen.getAllByRole("combobox")` and index into the array to target specific ones
  - For testing stream/grade labels with conditional styling, check both the labeled case (e.g., "Engineering") and the fallback case (unknown stream shows raw value)
---

## 2026-02-15T23:18 - US-003
Session: 97a2666f-4ba9-40a8-a434-2350323fa6a2
- Implemented 30 unit tests for SchoolList.tsx
- Files changed: `src/app/admin/schools/SchoolList.test.tsx` (new, 546 lines)
- Test coverage areas: rendering (school names, codes, regions, program badges, empty region dash, 'No programs' text, Edit buttons), stats display (CoE/Nodal/NVS/None counts with `within()` scoping), search by name (case-insensitive) and code, program filter dropdown (CoE/NVS/All), showing count updates, empty state, edit modal (open with school info, pre-selected programs, null program_ids, toggle checkboxes, close via Cancel/backdrop/X button), save (PATCH fetch with correct payload, Saving... state, server error message, generic error fallback, network error, non-Error thrown, error clearing on re-open), unknown program ID fallback
- **Learnings for future iterations:**
  - SchoolList props are `{ initialSchools }` — NOT `{ schools }` as PRD stated
  - When modal shows the same school name that's already in the table, `getByText()` will fail with multiple matches — use `getAllByText()` and check length instead
  - For stats cards with numeric counts, use `within(card)` scoping since values like "1" and "2" appear in multiple places on the page
  - Backdrop click test: query the backdrop div via `document.querySelector(".bg-opacity-30")` since it has no accessible role
---

## 2026-02-15T23:22 - US-004
Session: 76e96e0e-be33-409c-a1e6-2f41c6f1537b
- Implemented 32 unit tests for UserList.tsx
- Files changed: `src/app/admin/users/UserList.test.tsx` (new, 506 lines)
- Test coverage areas: rendering (all emails, (you) tag, role/level badges, program badges, No programs, read-only/read-write, access column for all 4 levels, No regions/schools assigned, unknown role/program fallback), Add User modal (create mode open, close, refetch on save, close on failed refetch), Edit modal (edit mode open, close), Delete (disabled for self case-insensitive, confirm dialog, successful removal, Deleting... loading, server error message, fallback error, network error), empty state (header-only table)
- **Learnings for future iterations:**
  - UserList props are `{ initialUsers, regions, currentUserEmail }` — matches PRD this time
  - "Admin" text appears many times (role badge + level badge for multiple users) — use `getAllByText` for shared label strings
  - Mock child components (AddUserModal) as stubs with `data-testid` + callback buttons to test parent integration without child complexity
  - `vi.stubGlobal("alert", vi.fn())` and `vi.stubGlobal("confirm", vi.fn(() => true))` in beforeEach to control window dialogs
---

## 2026-02-15T23:30 - US-005
Session: 7afe42b0-8dba-4938-b9f5-a0b5dd0eaf0f
- Verified Phase 1 coverage: all 680 tests pass across 44 test files
- Coverage results: 73.99% lines (target >= 73%), 74.07% statements, 71.35% branches, 67.71% functions
- Baseline was 62.16% lines — Phase 1 added ~12% coverage from 4 admin client component test files
- Files committed: `unit-coverage/coverage-summary.json`
- Lint: all 4 new test files pass lint individually (pre-existing 818 errors unrelated)
- Build: pre-existing type error in `e2e/helpers/db.ts:152` still present (not related to unit tests)
- **Learnings for future iterations:**
  - Verification stories are quick — just run coverage, check threshold, commit summary
  - Pre-existing `src/app/layout.tsx` change (suppressHydrationWarning) was present but not committed since it's unrelated
---

## 2026-02-15T23:28 - US-006
Session: 67608d82-1b1f-4de0-934e-1b2901cd7392
- Implemented 27 unit tests for CurriculumTab.tsx
- Files changed: `src/components/curriculum/CurriculumTab.test.tsx` (new, ~380 lines)
- Test coverage areas: rendering (heading, school name, grade/subject selectors, canEdit gating for Log Session button and View Only badge), localStorage loading (loadSessions/loadProgress on mount with school code), fetching chapters (default grade=11/subject=Physics, recalculating progress after fetch, error states: non-ok response, network error, non-Error thrown), grade/subject selector changes trigger refetch (grade 12, Chemistry), tab switching (Chapters default → History → back to Chapters), modal lifecycle (open via button, close via onClose callback, not rendered when canEdit=false), saving sessions (with chapter completion, without chapter completion, canEdit guard, topic detail Unknown fallback for missing topics), chapter completion in progress (existing entry gets isChapterComplete=true, new entry created for chapter not yet in progress), ProgressSummary integration, chapter toggle callback, empty chapters array
- **Learnings for future iterations:**
  - CurriculumTab props include `schoolName` in addition to `schoolCode` and `canEdit` — PRD omitted `schoolName`
  - Mock child components with `data-testid` + exposed callback buttons (e.g., `modal-save`, `modal-close`) to test parent integration cleanly
  - When testing session save with "Unknown" topic fallback, use chapters with empty topics arrays so the topicId from the mock modal won't match any chapter topic
  - `vi.stubGlobal("fetch", mockFetch)` pattern works well for curriculum fetch mocking — same pattern as other component tests
---

## 2026-02-15T23:33 - US-007
Session: 5fd0976a-24a5-428b-9741-a244e5fcf133
- Implemented 44 unit tests for LogSessionModal.tsx
- Files changed: `src/components/curriculum/LogSessionModal.test.tsx` (new, ~660 lines)
- Test coverage areas: rendering (header, date input pre-filled via getTodayDate, duration defaults 1h/0m, chapter list, Cancel/Save buttons, topic counts, placeholder text, disabled Save button), date input change, duration inputs (hours/minutes update, NaN→0 clamping), chapter expand/collapse (toggle expand/collapse, no-topics disabled button, no arrow for empty chapters), topic selection (toggle on/off, deselect, selected count badge, summary with chapter count, pluralization of "chapters", already-covered ✓ badge), chapter completion (mark/unmark complete, Will Complete badge, ✓ Complete badge for already-complete, disabled checkbox for already-complete, line-through style, completion summary count, enables Save button), form validation (disabled Save when nothing selected, zero duration alert), successful save (correct args with topics+chapters, multiple selections, duration calculation h*60+m), close/cancel (✕ button, Cancel button, backdrop click all call onClose), edge cases (empty chapters list, missing progress entry, chapter-only save without topics, placeholder hides on topic selection, placeholder hides on chapter completion)
- **Learnings for future iterations:**
  - LogSessionModal props `{ chapters, progress, onClose, onSave }` match PRD exactly — one of the rare cases where PRD props are correct
  - `type="date"` inputs also lack `htmlFor`/`id` association in this codebase — same pattern as email inputs, use `document.querySelector('input[type="date"]')`
  - When topic selection changes count badges, the same count text (e.g., "1 topics") may appear in both a blue selection badge and a gray total count for a different chapter — use `getAllByText()` and check `className` to distinguish
  - Chapter completion checkboxes can be targeted via `screen.getAllByRole("checkbox")` when chapter is not expanded (only chapter-level checkboxes visible), but after expanding use `within(row)` scoping to find the right one
  - The `checked={isMarkedComplete || isAlreadyComplete}` pattern means checking isAlreadyComplete requires the checkbox to be both checked AND disabled
---

## 2026-02-15T23:36 - US-008
Session: f4039aed-b6c1-4aa0-a45d-24da0bac0662
- Implemented 17 unit tests for ChapterAccordion.tsx
- Files changed: `src/components/curriculum/ChapterAccordion.test.tsx` (new, ~280 lines)
- Test coverage areas: empty state, chapter rendering with index numbers, progress indicator/color from helpers, completed/total topic counts (with and without progress entry), date display (formatDate with lastTaughtDate or null), time display (formatDuration when > 0, hidden when 0 or missing), expand/collapse (arrow rotation, topics visible/hidden, independent per chapter), TopicRow stub integration (isCompleted based on completedTopicIds, false when no progress), empty topics message, onToggleChapter callback
- **Learnings for future iterations:**
  - ChapterAccordion props are `{ chapters, progress, expandedChapterIds, onToggleChapter }` — expand state is controlled by parent
  - Simple presentational components with controlled state are straightforward to test — mock helpers, stub children, check rendering
  - The ▶ arrow character can be queried with `screen.getAllByText("▶")` and class checked for rotation
  - When a component uses optional chaining (`chapterProgress?.completedTopicIds.length || 0`), test both the undefined case and the populated case
---

## 2026-02-15T23:39 - US-009
Session: 05ce34ee-4fa6-448b-ac3a-242e1c501f5b
- Implemented 5 unit tests for SessionHistory.tsx
- Files changed: `src/components/curriculum/SessionHistory.test.tsx` (new, ~111 lines)
- Test coverage areas: empty state (no sessions message), single session rendering (date, duration via formatDuration mock, topics), grouping topics by chapter within a session, multiple sessions rendering, multiple chapters in same session
- **Learnings for future iterations:**
  - SessionHistory is a simple presentational component — no state, no effects, just maps sessions to JSX with topic grouping
  - The `formatSessionDate` helper inside the component uses `toLocaleDateString("en-IN")` — test with partial text match (e.g., `/Jan/`) since exact locale output varies by environment
  - Only `formatDuration` from curriculum-helpers needs mocking; `formatSessionDate` is internal to the component
---

## 2026-02-15T23:41 - US-010
Session: 2d0487e0-5f72-446a-b7f7-f69e81d926bd
- Implemented 5 unit tests for ProgressSummary.tsx
- Files changed: `src/components/curriculum/ProgressSummary.test.tsx` (new, 77 lines)
- Test coverage areas: chapters completed/total display, topics covered/total display, total time via formatDuration, calculateStats called with correct args, zero stats rendering
- **Learnings for future iterations:**
  - ProgressSummary is the simplest curriculum component — pure presentational, no state, no effects
  - Mock both `calculateStats` and `formatDuration` from curriculum-helpers, then just assert rendered text
  - Props match PRD exactly: `{ chapters, progress }`
---

## 2026-02-15T23:43 - US-011
Session: 8f3f5fa6-cedc-44eb-8495-49ca4be488a6
- Implemented 3 unit tests for TopicRow.tsx
- Files changed: `src/components/curriculum/TopicRow.test.tsx` (new, 59 lines)
- Test coverage areas: topic name and code rendering, uncompleted style (gray border, white bg, no SVG checkmark, text-gray-700), completed style (green bg/border, white text, SVG checkmark rendered, text-gray-500)
- All 6 branches covered via isCompleted true/false toggle
- **Learnings for future iterations:**
  - TopicRow is the simplest curriculum component — pure presentational, no state, no effects, no mocked dependencies
  - All 6 branches are driven by a single boolean prop `isCompleted` — just need two render scenarios
  - Use `container.querySelector("span.bg-green-500")` to target Tailwind-styled elements without accessible roles
---
