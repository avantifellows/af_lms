# Ralph Progress Log
Started: Sun Feb 15 23:07:30 IST 2026

## Codebase Patterns
- **Client component tests**: Use `@testing-library/react` + `userEvent.setup()` for interactions
- **Email inputs**: `type="email"` inputs have no label-input `htmlFor`/`id` association; query with `document.querySelector('input[type="email"]')` instead of `getByRole("textbox", { name: /email/i })`
- **Debounce testing**: Use `vi.useFakeTimers({ shouldAdvanceTime: true })` + `userEvent.setup({ advanceTimers: vi.advanceTimersByTime })`, then `vi.advanceTimersByTime(delay)` wrapped in `act()`
- **Fetch mocking**: `vi.stubGlobal("fetch", mockFetch)` with `mockFetch = vi.fn()` in `beforeEach`
- **Pre-existing build failure**: `e2e/helpers/db.ts:152` has type error (`string | undefined` not assignable to `string`) — not caused by unit tests
- **Pre-existing lint errors**: 818 errors exist in codebase; new test files should lint clean individually with `npx eslint <file>`
- **AddUserModal props**: `{ user, regions, onClose, onSave }` — NOT `{ isOpen, onClose, onSave, editUser, currentUserEmail }` as PRD stated
- **Multiple selects**: Use `screen.getAllByRole("combobox")` and index to target specific `<select>` elements
- **PRD props often wrong**: Always read actual source component to get real props interface before writing tests
- **Duplicate text in table+modal**: When a component shows the same text in a table row AND a modal, use `getAllByText()` or scope queries with `within()` to avoid `getByText` failing on multiple matches
- **Stats card counts**: Use `within(card)` scoping to check stat values, since count numbers like "1" or "2" may appear multiple times on page
- **Mock child components**: Use `vi.mock("./ChildComponent", ...)` with stub that exposes `data-testid` + callback buttons to test parent integration cleanly
- **Window dialogs**: `vi.stubGlobal("alert", vi.fn())` + `vi.stubGlobal("confirm", vi.fn(() => true))` in `beforeEach` for components using `alert()`/`confirm()`
- **Date inputs without htmlFor**: `type="date"` inputs may lack `htmlFor`/`id` association; query with `document.querySelector('input[type="date"]')` instead of `getByLabelText("Date")`
- **Duplicate count badges**: When selecting topics changes a count badge and another chapter has the same count text, use `getAllByText()` and check `className` to distinguish blue (selected) vs gray (total) badges
- **React 19 use(params) in client components**: Wrap component in `<Suspense>` and use `await act(async () => { render(...) })` to let the Promise resolve before assertions
- **Server component test pattern**: Use `vi.hoisted()` for mock variables referenced in `vi.mock()` factories. Redirect sentinel: `mockRedirect = vi.fn((url) => { throw new Error('REDIRECT:' + url); })`. Test redirects: `await expect(Page()).rejects.toThrow("REDIRECT:/")`. Test rendering: `const jsx = await Page(); render(jsx);`. Mock `next/link` as `<a>` stub. Mock `next-auth`, `@/lib/auth`, `next/navigation`, and permission functions.
- **Top-level env vars**: Pages that use `const X = process.env.X` at module top-level capture env vars at import time. Since `vi.mock()` is hoisted above `process.env` assignments, use pattern-matching (`expect(url).toContain(...)`) for fetch URL assertions instead of exact URL matching.
- **resetAllMocks for server pages**: Use `vi.resetAllMocks()` (not `clearAllMocks`) in `beforeEach` for server component tests with `mockResolvedValueOnce()` — `clearAllMocks` does NOT clear pending once-queues, causing mock leakage. After `resetAllMocks`, re-establish sentinel implementations for redirect/notFound.
- **Recharts mock coverage**: Mock `Bar`/`Pie` to render `{children}` (not `() => null`) so `.map()` Cell callbacks execute. Mock `Tooltip`/`Pie` to invoke callback props (`formatter`, `label`) so those arrow functions get V8 coverage. Use typed interfaces (`type P = { children?: React.ReactNode }`) to avoid lint `any` errors.

- **Tailwind v4 @theme inline**: Register CSS custom properties in `@theme inline { }` block to generate utility classes (e.g., `--color-accent: var(--color-accent)` → enables `bg-accent`, `text-accent`, `border-accent`). Without registration, must use verbose `bg-[var(--color-accent)]` syntax.
- **Focus ring suppression**: Global CSS handles `outline: none` and `--tw-ring-shadow` reset for all interactive elements. Still need to remove `focus:ring-*` classes from JSX to avoid generating unused CSS.
- **Status badges**: Use `statusBadgeClass(status)` from `@/lib/visit-actions` — includes `rounded-full px-2.5 py-0.5 text-xs font-medium` + theme colors. Callers just need `inline-flex ${statusBadgeClass(status)}`.
- **Progressive padding**: `px-4 sm:px-6 md:px-16 lg:px-32 xl:px-64 2xl:px-96 py-6 md:py-8` — full-bleed page layout wrapper
- **Table headers (Ledger)**: `bg-bg-card-alt border-b-2 border-border-accent` with `text-xs font-bold text-text-muted uppercase tracking-wider`
- **Section headers (Ledger)**: `text-lg font-bold text-text-primary uppercase tracking-wide mb-4 border-b-2 border-border-accent pb-2`
- **Font-mono in text strings**: Don't wrap numbers in `<span>` inside getByText-tested strings — RTL can't match split text. Use `font-mono` on parent container instead.

---

## 2026-02-26 - US-001
Session: fa216564-1fc8-4ecf-a907-c2529187b695
- Implemented Ledger UI design tokens as CSS custom properties in globals.css
- Registered all 19 tokens in @theme inline block for Tailwind v4 utility class generation
- Deleted dark mode media query (light-mode-only internal tool)
- Added global focus ring suppression CSS for all interactive elements
- Created src/lib/theme.ts for dynamic inline styles where CSS vars can't work
- Files changed: src/app/globals.css, src/lib/theme.ts (new)
- **Learnings for future iterations:**
  - Tailwind v4 requires tokens registered in `@theme inline` to generate utility classes — without this, only `bg-[var(--color-X)]` works
  - Dark mode query was deleted; this is intentional for an internal light-mode-only tool
  - theme.ts is scoped to inline styles only — never use for color refs in JSX className
---

## 2026-02-26 - US-002
Session: f73cd00e-94f0-47a5-83d7-84a5ee8b1b60
- Created shared `statusBadgeClass(status)` in `src/lib/visit-actions.ts` with 4 branches: completed, in_progress, pending, unknown fallback
- Returns base classes `rounded-full px-2.5 py-0.5 text-xs font-medium` + status-specific bg/text using Ledger theme tokens
- Removed `visitStatusClass()` from `src/app/visits/[id]/page.tsx` — replaced with shared import
- Removed `actionStatusClass()` from `src/components/visits/ActionPointList.tsx` — replaced with shared import
- Removed `actionStatusClass()` from `src/components/visits/ActionDetailForm.tsx` — replaced with shared import
- Replaced inline status ternary in `src/app/dashboard/page.tsx` with `statusBadgeClass()` import
- Replaced inline status ternary in `src/components/SchoolTabs.tsx` with `statusBadgeClass()` import
- Files changed: src/lib/visit-actions.ts, src/app/visits/[id]/page.tsx, src/components/visits/ActionPointList.tsx, src/components/visits/ActionDetailForm.tsx, src/app/dashboard/page.tsx, src/components/SchoolTabs.tsx
- npm run build passes, npm run test passes (1100/1100)
- **Learnings for future iterations:**
  - `statusBadgeClass()` includes `rounded-full` in its base — callers should NOT also add `rounded-full`
  - Badge callers that previously had `px-2 py-1 text-xs font-semibold rounded-full` now use `inline-flex ${statusBadgeClass(status)}` — the shared helper owns the badge sizing/rounding
  - All 5 duplicated status badge class helpers are now consolidated into one location
---

## 2026-02-26 - US-003
Session: 7365b7f4-0955-44d3-ace6-d9f987441566
- Restyled `src/app/visits/page.tsx` to Ledger UI design system
- Page layout: replaced `max-w-7xl mx-auto` with full-bleed `min-h-screen bg-bg` + progressive padding wrapper
- Page header: added 4px emerald bottom border (`border-b-4 border-border-accent`), uppercase tracking-tight title
- Section headers (In Progress / Completed): uppercase tracking-wide font-bold, 2px accent bottom border
- Filter form: sharp corners, `bg-bg-card border-border`, themed labels, border-2 inputs with accent focus
- Apply button: `bg-accent` sharp uppercase bold. Reset link: secondary style with border
- Tables: sharp corners, no shadow, `bg-bg-card border-border`. Headers: `bg-bg-card-alt` + 2px accent bottom border
- Table body: per-row `border-b border-border/40` (replaced `divide-y divide-gray-200`). Row hover: `hover:bg-hover-bg`
- Date cells: added `font-mono`. Count stats: `font-mono` on parent container
- Continue button: accent sharp uppercase bold. View link: `text-accent` font-bold uppercase
- Empty state: centered uppercase muted text with accent link
- Removed ALL `rounded-md`, `rounded-lg`, `shadow`, hardcoded `gray-*`/`blue-*` classes
- Files changed: src/app/visits/page.tsx
- npm run build passes, npm run test passes (1100/1100)
- **Learnings for future iterations:**
  - When adding `font-mono` to individual numbers inside a text string, wrapping in `<span>` breaks RTL `getByText()` assertions — use `font-mono` on the parent container instead
  - Progressive padding pattern: `px-4 sm:px-6 md:px-16 lg:px-32 xl:px-64 2xl:px-96 py-6 md:py-8`
  - Section header pattern: `text-lg font-bold text-text-primary uppercase tracking-wide mb-4 border-b-2 border-border-accent pb-2`
  - Table header pattern: `bg-bg-card-alt border-b-2 border-border-accent` with `text-xs font-bold text-text-muted uppercase tracking-wider`
---

## 2026-02-26 - US-004
Session: 45aeb0c4-094a-4561-8201-cb185492a155
- Restyled visit-related elements in `src/app/dashboard/page.tsx` to Ledger UI
- Recent Visits section header: uppercase tracking-wide font-bold text-text-primary
- "View all" link: text-accent hover:text-accent-hover font-bold uppercase
- Table wrapper: sharp corners (`bg-bg-card border border-border`), removed shadow and rounded-lg
- Table headers: `bg-bg-card-alt border-b-2 border-border-accent`, font-bold text-text-muted
- Table body: removed `divide-y divide-gray-200`, added per-row `border-b border-border/40 hover:bg-hover-bg`
- Visit date cells: added `font-mono`, text-text-secondary
- View/Continue links: text-accent hover:text-accent-hover font-bold
- Start Visit button on school cards: bg-accent sharp uppercase (replaced bg-green-600 rounded-md)
- Status badges already using shared `statusBadgeClass()` from US-002
- Files changed: src/app/dashboard/page.tsx
- npm run build passes, npm run test passes (1100/1100)
- **Learnings for future iterations:**
  - Dashboard visit restyling is scoped — only Recent Visits table + Start Visit button. Do NOT restyle school cards, pagination, search, stats, or nav elements.
  - The `statusBadgeClass()` integration was already done in US-002, so this step only needed visual class changes.
---

## 2026-02-26 - US-005
Session: 770207b2-8c63-4071-9a80-e149ac084a05
- Restyled `src/app/visits/[id]/page.tsx` to Ledger UI design system
- Page layout: replaced `max-w-4xl mx-auto` with full-bleed `min-h-screen bg-bg` + progressive padding wrapper
- Back link: `text-accent hover:text-accent-hover font-semibold uppercase` (replaced `text-gray-500`)
- Visit info card: sharp corners (`bg-bg-card border border-border`), removed shadow and rounded-lg
- Title: added `uppercase tracking-tight text-text-primary`
- Visit date: `text-text-secondary` (replaced `text-gray-500`)
- Timestamps: `text-text-muted font-mono` (replaced `text-gray-400`)
- Status badge: simplified to `inline-flex ${statusBadgeClass()}` — removed redundant sizing classes already in helper
- Progress bar: sharp (removed `rounded-full` on track and fill), added `role="progressbar"` + `aria-valuenow`/`aria-valuemin`/`aria-valuemax` accessibility attrs
- Progress fill: `bg-accent` (replaced `bg-green-600`)
- Progress numbers: added `font-mono`
- Read-only notices: `bg-bg-card-alt border border-border` sharp (replaced `bg-gray-50 rounded-md`)
- Not-found state: sharp, theme danger (`bg-danger-bg border-danger/20 text-danger`), added `role="alert"`
- Forbidden state: sharp, theme warning (`bg-warning-bg border-warning-border text-warning-text`), added `role="alert"`
- Files changed: src/app/visits/[id]/page.tsx
- npm run build passes, npm run test passes (1100/1100)
- **Learnings for future iterations:**
  - `statusBadgeClass()` already includes `rounded-full px-2.5 py-0.5 text-xs font-medium` — callers only need `inline-flex ${statusBadgeClass(status)}`, no extra sizing/font classes
  - Progress bar accessibility: add `role="progressbar"` + `aria-valuenow`/`aria-valuemin={0}`/`aria-valuemax={100}` on the track div
  - Not-found/forbidden states use `role="alert"` for screen reader announcements
---

## 2026-02-26 - US-006
Session: bcd75233-206d-4c8e-a4a5-1d790ebd009e
- Restyled action detail page shell in `src/app/visits/[id]/actions/[actionId]/page.tsx` to Ledger UI
- Page layout: replaced `max-w-4xl mx-auto` with full-bleed `min-h-screen bg-bg` + progressive padding wrapper on all 3 render paths (notFoundState, forbiddenState, main)
- Back links: `text-accent hover:text-accent-hover font-semibold uppercase` (replaced `text-gray-500 hover:text-gray-700`)
- `notFoundState()` helper: sharp corners, `bg-danger-bg border-danger/20 text-danger`, added `role="alert"` — removed `rounded-lg border-red-200 bg-red-50`
- `forbiddenState()` helper: sharp corners, `bg-warning-bg border-warning-border text-warning-text`, added `role="alert"` — removed `rounded-lg border-yellow-200 bg-yellow-50`
- Files changed: src/app/visits/[id]/actions/[actionId]/page.tsx
- npm run build passes, npm run test passes (1100/1100)
- **Learnings for future iterations:**
  - This page has 3 render paths sharing the same layout pattern — notFoundState (used for both visit-not-found and action-not-found), forbiddenState, and the main success path. All 3 need the same full-bleed + progressive padding wrapper.
  - The notFoundState helper is parameterized (title, description) and used twice with different messages — update both usages via the shared helper, not inline.
  - No test assertions broke because the page test file uses only semantic queries (getByText, getByRole) — no class name assertions exist.
---