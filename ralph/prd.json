{
  "project": "af_lms",
  "branchName": "ralph/unit-test-coverage-90",
  "description": "Increase unit test coverage from 62% to 90%+ by adding tests for 24 zero-coverage files and closing gaps in 11 partially-covered files",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add unit tests for AddUserModal",
      "description": "As a developer, I want unit tests for src/app/admin/users/AddUserModal.tsx (81 uncovered lines, 76 branches) so that the create/edit user modal is regression-tested.",
      "acceptanceCriteria": [
        "Test file created at src/app/admin/users/AddUserModal.test.tsx",
        "~30 tests covering: create mode vs edit mode rendering, level-based UI visibility (level 1 shows school picker, level 2 shows region picker), debounced school search (vi.useFakeTimers + userEvent.setup({ advanceTimers })), program ID validation, form submission with fetch mock, error display, close/cancel behavior",
        "All branches for level-dependent field visibility tested (levels 1-4)",
        "Mock fetch for school search endpoint and save endpoint",
        "Use vi.useFakeTimers() with userEvent.setup({ advanceTimers: vi.advanceTimersByTime }) for debounce testing",
        "Props interface: { isOpen, onClose, onSave, editUser?, currentUserEmail }",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 1,
      "passes": true,
      "notes": "52 tests added. Props interface is { user, regions, onClose, onSave } not { isOpen, onClose, onSave, editUser, currentUserEmail }. Build has pre-existing type error in e2e/helpers/db.ts:152 unrelated to this story."
    },
    {
      "id": "US-002",
      "title": "Add unit tests for BatchList",
      "description": "As a developer, I want unit tests for src/app/admin/batches/BatchList.tsx (60 uncovered lines, 48 branches) so that batch metadata editing is regression-tested.",
      "acceptanceCriteria": [
        "Test file created at src/app/admin/batches/BatchList.test.tsx",
        "~18 tests covering: initial render with batch data, program selector fetch, inline edit mode toggle, save/cancel behavior, loading states, error states, empty batch list",
        "Props: { initialBatches, dbServiceUrl, dbServiceToken }",
        "Mock fetch for program list and batch PATCH endpoints",
        "Test the program selector triggering batch re-fetch",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 2,
      "passes": true,
      "notes": "26 tests added. Props are { initialBatches, programs, initialProgramId } not { initialBatches, dbServiceUrl, dbServiceToken }. Covers: rendering, empty state, program change with fetch, edit mode toggle, save/cancel, error states (server + network), unknown stream fallback."
    },
    {
      "id": "US-003",
      "title": "Add unit tests for SchoolList",
      "description": "As a developer, I want unit tests for src/app/admin/schools/SchoolList.tsx (54 uncovered lines, 42 branches) so that school program assignment editing is regression-tested.",
      "acceptanceCriteria": [
        "Test file created at src/app/admin/schools/SchoolList.test.tsx",
        "~18 tests covering: school list rendering, search/filter functionality, edit modal opens with correct data, program checkbox toggling (CoE/Nodal/NVS), save program changes, stats display, empty/filtered states",
        "Props: { schools } (array of school objects with program_ids)",
        "Mock fetch for PATCH school program_ids",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 3,
      "passes": true,
      "notes": "30 tests added. Props are { initialSchools } not { schools }. Covers: rendering (school names, codes, regions, program badges, empty region dash, 'No programs' text), stats display (CoE/Nodal/NVS/None counts), search by name (case-insensitive) and code, program filter (CoE/NVS/All), empty state, edit modal (open with school info, pre-selected programs, null programs, toggle checkboxes, close via Cancel/backdrop/X), save (PATCH fetch, Saving state, server error, generic error, network error, non-Error thrown, error clearing on re-open), unknown program ID fallback."
    },
    {
      "id": "US-004",
      "title": "Add unit tests for UserList",
      "description": "As a developer, I want unit tests for src/app/admin/users/UserList.tsx (39 uncovered lines, 43 branches) so that user management actions are regression-tested.",
      "acceptanceCriteria": [
        "Test file created at src/app/admin/users/UserList.test.tsx",
        "~14 tests covering: user table rendering, add user opens AddUserModal, edit user opens AddUserModal with pre-filled data, delete user with confirmation, self-delete prevention (vi.stubGlobal('confirm', ...)), refetch after save, empty user list",
        "Props: { users, regions, currentUserEmail }",
        "Mock the AddUserModal child component as a stub to isolate UserList logic",
        "Use vi.stubGlobal('confirm', vi.fn(() => true)) for delete confirmation",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 4,
      "passes": true,
      "notes": "32 tests added. Props are { initialUsers, regions, currentUserEmail }. Covers: rendering (emails, (you) tag, role/level badges, program badges, No programs, read-only/read-write, access column for all levels, fallback for unknown role/program), Add User modal (open in create mode, close, refetch on save, close on failed refetch), Edit modal (open in edit mode, close), Delete (self-delete disabled via case-insensitive check, confirm dialog, successful delete removes from list, Deleting... loading state, server error message, fallback error, network error), empty state."
    },
    {
      "id": "US-005",
      "title": "Verify Phase 1 coverage (~74%)",
      "description": "As a developer, I want to verify that Phase 1 tests (admin client components) bring coverage to ~74% and all tests pass together.",
      "acceptanceCriteria": [
        "Run npm run test:unit:coverage — all tests pass",
        "Line coverage is >=73% (target: 74.1%, baseline was 62.16%)",
        "Commit updated unit-coverage/coverage-summary.json",
        "Build passes (npm run build)",
        "Lint passes (npm run lint)"
      ],
      "priority": 5,
      "passes": true,
      "notes": "680 tests pass across 44 files. Line coverage: 73.99% (>= 73% threshold). Statement coverage: 74.07%. Lint clean on all new test files. Build has pre-existing e2e/helpers/db.ts type error (not related)."
    },
    {
      "id": "US-006",
      "title": "Add unit tests for CurriculumTab",
      "description": "As a developer, I want unit tests for src/components/curriculum/CurriculumTab.tsx (63 uncovered lines, 29 branches) so that the curriculum tracking UI is regression-tested.",
      "acceptanceCriteria": [
        "Test file created at src/components/curriculum/CurriculumTab.test.tsx",
        "~15 tests covering: grade/subject selector rendering, fetch chapters on grade/subject change, localStorage persistence via mocked helpers (loadSessions, saveSessions, loadProgress, saveProgress), tab switching (Chapters / History), modal open/close lifecycle, canEdit gating (hides Log Session button when false), empty state when no chapters",
        "Mock child components (ProgressSummary, ChapterAccordion, SessionHistory, LogSessionModal) as stubs to isolate CurriculumTab logic",
        "Props: { schoolCode, canEdit }",
        "Mock @/lib/curriculum-helpers module entirely",
        "Mock fetch for /api/curriculum/chapters endpoint",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 6,
      "passes": true,
      "notes": "27 tests added. Props are { schoolCode, schoolName, canEdit } not { schoolCode, canEdit } as PRD stated. Covers: rendering (heading, school name, grade/subject selectors, canEdit gating for Log Session button and View Only badge), localStorage loading (loadSessions, loadProgress on mount), fetching chapters (default grade/subject, recalculating progress, error states for non-ok/network/non-Error), grade/subject selector changes trigger refetch, tab switching (Chapters/History/back), modal lifecycle (open, close, not rendered when canEdit=false), saving sessions (with/without chapter completion, topic detail Unknown fallback, canEdit guard), chapter completion progress (existing/new entries), ProgressSummary integration, chapter toggle, empty chapters."
    },
    {
      "id": "US-007",
      "title": "Add unit tests for LogSessionModal",
      "description": "As a developer, I want unit tests for src/components/curriculum/LogSessionModal.tsx (62 uncovered lines, 58 branches) so that session logging validation is regression-tested.",
      "acceptanceCriteria": [
        "Test file created at src/components/curriculum/LogSessionModal.test.tsx",
        "~20 tests covering: modal rendering with chapter list, date input validation, duration input validation, Set-based topic selection (toggle topics on/off), chapter-level completion marking, form validation (no topics + no chapters selected = error), successful save callback, close/cancel behavior, pre-filled date from getTodayDate",
        "All 58 branches tested — pay attention to nested topic/chapter selection logic",
        "Props: { isOpen, onClose, onSave, chapters, progress }",
        "Mock @/lib/curriculum-helpers for getTodayDate",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 7,
      "passes": true,
      "notes": "44 tests added. Props are { chapters, progress, onClose, onSave } as PRD stated. Covers: rendering (header, date input pre-filled via getTodayDate, duration defaults 1h/0m, chapter list, Cancel/Save buttons, topic counts, placeholder text, disabled Save), date input change, duration inputs (hours/minutes update, NaN→0 clamping), chapter expand/collapse (toggle, no-topics disabled, no arrow for empty), topic selection (toggle on/off, deselect, selected count badge, summary with chapter count, pluralization, already-covered badge), chapter completion (mark/unmark complete, Will Complete/✓ Complete badges, disabled for already-complete, line-through style, completion summary, enables Save), form validation (disabled button when nothing selected, zero duration alert), successful save (correct args, multiple topics+chapters, duration calculation), close/cancel (✕ button, Cancel button, backdrop click), edge cases (empty chapters, missing progress entry, chapter-only save, placeholder hide on selection)."
    },
    {
      "id": "US-008",
      "title": "Add unit tests for ChapterAccordion",
      "description": "As a developer, I want unit tests for src/components/curriculum/ChapterAccordion.tsx (12 uncovered lines, 16 branches) so that chapter expand/collapse and progress display are tested.",
      "acceptanceCriteria": [
        "Test file created at src/components/curriculum/ChapterAccordion.test.tsx",
        "~6 tests covering: collapsed state (only header visible), expanded state (topics visible), progress indicator display, completion count, time spent formatting, empty topics list",
        "Props: { chapter, progress }",
        "Mock @/lib/curriculum-helpers for getProgressIndicator, getProgressColorClass, formatDuration, formatDate",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 8,
      "passes": true,
      "notes": "17 tests added. Props are { chapters, progress, expandedChapterIds, onToggleChapter }. Covers: empty state (no chapters), chapter rendering (names with index numbers, progress indicator/color from helpers, completed/total topic counts, 0/N when no progress), date/time display (formatDate with lastTaughtDate or null, formatDuration when totalTimeMinutes > 0, hidden when 0 or missing), expand/collapse (arrow rotate-90 class, topics visible when expanded, hidden when collapsed, independent per chapter), topic rendering (TopicRow stub with isCompleted based on completedTopicIds, false when no progress entry), empty topics ('No topics defined'), onToggleChapter callback with chapter ID."
    },
    {
      "id": "US-009",
      "title": "Add unit tests for SessionHistory",
      "description": "As a developer, I want unit tests for src/components/curriculum/SessionHistory.tsx (17 uncovered lines, 4 branches) so that session display is tested.",
      "acceptanceCriteria": [
        "Test file created at src/components/curriculum/SessionHistory.test.tsx",
        "~5 tests covering: empty state (no sessions), sessions grouped by chapter, date/duration formatting, multiple sessions for same chapter",
        "Props: { sessions } (array of TeachingSession)",
        "Mock @/lib/curriculum-helpers for formatDuration",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 9,
      "passes": true,
      "notes": "5 tests added. Props are { sessions } (array of TeachingSession). Covers: empty state (no sessions message with Log Session hint), single session rendering (date via toLocaleDateString, duration via formatDuration mock, topics grouped by chapter), multiple sessions, topics grouped by chapter within a session (two chapters from one session), multiple chapters in same session with bullet-pointed topic lists."
    },
    {
      "id": "US-010",
      "title": "Add unit tests for ProgressSummary",
      "description": "As a developer, I want unit tests for src/components/curriculum/ProgressSummary.tsx (2 uncovered lines) so that summary stats display is tested.",
      "acceptanceCriteria": [
        "Test file created at src/components/curriculum/ProgressSummary.test.tsx",
        "~2 tests covering: renders chapters completed / topics covered / total time from mocked calculateStats helper",
        "Props: { chapters, progress }",
        "Mock @/lib/curriculum-helpers for calculateStats, formatDuration",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 10,
      "passes": true,
      "notes": "5 tests added. Props are { chapters, progress }. Covers: chapters completed/total display, topics covered/total display, total time via formatDuration, calculateStats called with correct args, zero stats rendering."
    },
    {
      "id": "US-011",
      "title": "Add unit tests for TopicRow",
      "description": "As a developer, I want unit tests for src/components/curriculum/TopicRow.tsx (1 uncovered line, 6 branches) so that topic display variants are tested.",
      "acceptanceCriteria": [
        "Test file created at src/components/curriculum/TopicRow.test.tsx",
        "~3 tests covering: completed topic styling, uncompleted topic styling, topic code display, all 6 branch variations",
        "Props: { topic, isCompleted }",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 11,
      "passes": true,
      "notes": "3 tests added. Props are { topic, isCompleted } matching PRD. Covers: topic name and code rendering, uncompleted style (gray border, white bg, no SVG, darker text-gray-700), completed style (green bg, green border, white text, SVG checkmark rendered, muted text-gray-500). All 6 branches covered via isCompleted true/false."
    },
    {
      "id": "US-012",
      "title": "Verify Phase 2 coverage (~82%)",
      "description": "As a developer, I want to verify that Phase 2 tests (curriculum components) bring coverage to ~82% and all tests pass together.",
      "acceptanceCriteria": [
        "Run npm run test:unit:coverage — all tests pass",
        "Line coverage is >=80% (target: 82.1%)",
        "Commit updated unit-coverage/coverage-summary.json",
        "Build passes (npm run build)",
        "Lint passes (npm run lint)"
      ],
      "priority": 12,
      "passes": true,
      "notes": "781 tests pass across 50 files. Line coverage: 81.84% (>= 80% threshold). Statement coverage: 81.69%. Branch coverage: 78.01%. Functions: 79.85%. Phase 2 added ~8% coverage from 6 curriculum component test files. Lint clean on all new test files. Build has pre-existing e2e/helpers/db.ts type error (not related)."
    },
    {
      "id": "US-013",
      "title": "Add unit tests for Login page",
      "description": "As a developer, I want unit tests for src/app/page.tsx (23 uncovered lines, 12 branches) so that the login flow is regression-tested.",
      "acceptanceCriteria": [
        "Test file created at src/app/page.test.tsx",
        "~12 tests covering: Google OAuth signIn('google') call on button click, passcode form toggle (show/hide), 8-digit passcode validation (too short, too long, non-numeric rejected), successful passcode submission calls signIn('passcode', ...), success redirect via router.push, error display on failed sign-in, initial state (Google button visible, passcode form hidden)",
        "Mock next-auth/react (signIn)",
        "Mock next/navigation (useRouter)",
        "'use client' component — standard RTL testing",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 13,
      "passes": true,
      "notes": "16 tests added. Covers: initial state (Google button, passcode toggle, heading, subtitle), Google OAuth (signIn('google') call), passcode form toggle (show/hide, hides Google button), passcode input validation (strips non-numeric chars, limits to 8 digits, disable/enable Continue button), passcode submission (signIn('passcode') call, 'Verifying...' loading state, disabled button during loading), success redirect (router.push to /school/{first5digits}), error display ('Invalid passcode'), error clearing on re-submit, no-op when result has neither ok nor error, back button (clears passcode + error, returns to login options)."
    },
    {
      "id": "US-014",
      "title": "Add unit tests for Principal Meeting page",
      "description": "As a developer, I want unit tests for src/app/visits/[id]/principal/page.tsx (58 uncovered lines, 32 branches) so that the principal meeting form is regression-tested.",
      "acceptanceCriteria": [
        "Test file created at src/app/visits/[id]/principal/page.test.tsx",
        "~18 tests covering: form load via fetch (mock GET response), field updates (textarea changes), save button triggers PATCH fetch, save & return navigates via router.push, error display on fetch failure, loading state, empty/pre-filled form fields, React 19 use(params) — pass Promise.resolve({ id: '1' }) as params prop",
        "Mock next/navigation (useRouter)",
        "Mock next/link",
        "Mock fetch for GET visit and PATCH save endpoints",
        "Uses React 19 use() hook — pass params as Promise.resolve({ id: '1' })",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 14,
      "passes": true,
      "notes": "23 tests added. Props use React 19 use(params) with Promise<{ id: string }>. Covers: loading skeleton, data loading (pre-filled form, empty form, school_code fallback), fetch errors (non-ok, network, non-Error), form interactions (textarea change shows 'Unsaved changes', process confirmation checkboxes, resource access checkboxes), save via PATCH (success resets to 'All changes saved', server error message, fallback error, network error, non-Error thrown, disabled when saved), Save & Return (navigates on success, Saving... button/status text with yellow color, stale closure bug: navigates even on failure), navigation links (back + cancel to /visits/{id}), form field labels and checkbox labels."
    },
    {
      "id": "US-015",
      "title": "Verify Phase 3 coverage (~86%)",
      "description": "As a developer, I want to verify that Phase 3 tests (client pages) bring coverage to ~86%.",
      "acceptanceCriteria": [
        "Run npm run test:unit:coverage — all tests pass",
        "Line coverage is >=84% (target: 86.2%)",
        "Commit updated unit-coverage/coverage-summary.json",
        "Build passes (npm run build)",
        "Lint passes (npm run lint)"
      ],
      "priority": 15,
      "passes": true,
      "notes": "820 tests pass across 52 files. Line coverage: 85.56% (>= 84% threshold). Statement coverage: 85.33%. Branch coverage: 80.61%. Functions: 84.22%. Phase 3 added ~4% coverage from 2 client page test files (Login, Principal Meeting). Lint clean on both Phase 3 test files. Build has pre-existing e2e/helpers/db.ts type error (not related)."
    },
    {
      "id": "US-016",
      "title": "Spike — Validate server component test pattern with admin/page.tsx",
      "description": "As a developer, I want to validate the async server component testing pattern on the simplest server page (src/app/admin/page.tsx, 7 lines, 4 branches) before scaling to complex pages.",
      "acceptanceCriteria": [
        "Test file created at src/app/admin/page.test.tsx",
        "~3 tests covering: no session -> redirect to /, session but not admin -> redirect to /dashboard, admin session -> renders admin links",
        "Pattern confirmed: calling Page() as async function works, redirect throws sentinel, render(jsx) works for success case",
        "Mock: next-auth (getServerSession), @/lib/auth (authOptions), next/navigation (redirect), @/lib/permissions (isAdmin), next/link",
        "Use sentinel pattern: redirect: vi.fn((url) => { throw new Error('REDIRECT:' + url); }), notFound: vi.fn(() => { throw new Error('NOT_FOUND'); })",
        "If pattern doesn't work (e.g. JSX rendering issues with server components in jsdom), document the issue and adjust approach",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 16,
      "passes": true,
      "notes": "5 tests added. Pattern validated: vi.hoisted() required for mock variables in vi.mock() factories; async Page() call + rejects.toThrow('REDIRECT:...') for redirect tests; await Page() + render(jsx) for success case. Mock next/link as simple <a> stub. All 825 tests pass across 53 files."
    },
    {
      "id": "US-017",
      "title": "Add unit tests for admin/batches/page.tsx",
      "description": "As a developer, I want unit tests for src/app/admin/batches/page.tsx (17 uncovered lines, 6 branches) so that the batch management server page is tested.",
      "acceptanceCriteria": [
        "Test file created at src/app/admin/batches/page.test.tsx",
        "~3 tests covering: admin check (no session -> redirect, not admin -> redirect), fetches batches from DB_SERVICE_URL (mock fetch), renders BatchList component with fetched data",
        "Mock: next-auth, @/lib/auth, next/navigation, @/lib/permissions, next/link",
        "Mock fetch for DB_SERVICE_URL batch list",
        "Mock BatchList as stub component",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 17,
      "passes": true,
      "notes": "5 tests added. Covers: no session redirect, no email redirect, not admin redirect, admin renders BatchList with fetched batches (header, nav, props verification, fetch URL/options), empty batches on fetch failure. Env vars captured at module load time — use pattern-matching for fetch URL assertion. All 830 tests pass across 54 files."
    },
    {
      "id": "US-018",
      "title": "Add unit tests for admin/schools/page.tsx",
      "description": "As a developer, I want unit tests for src/app/admin/schools/page.tsx (9 uncovered lines, 4 branches) so that the school management server page is tested.",
      "acceptanceCriteria": [
        "Test file created at src/app/admin/schools/page.test.tsx",
        "~3 tests covering: admin check redirects, query for JNV schools, renders SchoolList with query results",
        "Mock: next-auth, @/lib/auth, next/navigation, @/lib/permissions, @/lib/db (query), next/link",
        "Mock SchoolList as stub component",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 18,
      "passes": true,
      "notes": "5 tests added. Covers: no session redirect, no email redirect, not admin redirect, admin renders SchoolList with queried JNV schools (header, school count, email, sign out link, props verification, query SQL assertion), empty schools array. Uses query mock from @/lib/db. All 835 tests pass across 55 files."
    },
    {
      "id": "US-019",
      "title": "Add unit tests for admin/users/page.tsx",
      "description": "As a developer, I want unit tests for src/app/admin/users/page.tsx (11 uncovered lines, 4 branches) so that the user management server page is tested.",
      "acceptanceCriteria": [
        "Test file created at src/app/admin/users/page.test.tsx",
        "~3 tests covering: admin check redirects, parallel user + region DB queries, renders UserList with both datasets",
        "Mock: next-auth, @/lib/auth, next/navigation, @/lib/permissions, @/lib/db (query — called twice, use .mockResolvedValueOnce()), next/link",
        "Mock UserList as stub component",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 19,
      "passes": true,
      "notes": "5 tests added. Covers: no session redirect, no email redirect, not admin redirect, admin renders UserList with parallel-fetched users and regions (header, user count, email, sign out link, props verification: initialUsers, regions mapped to strings, currentUserEmail, both SQL query assertions), empty users and regions. Uses mockQuery.mockResolvedValueOnce() chaining for parallel Promise.all queries. All 840 tests pass across 56 files."
    },
    {
      "id": "US-020",
      "title": "Add unit tests for school/[udise]/visit/new/page.tsx",
      "description": "As a developer, I want unit tests for src/app/school/[udise]/visit/new/page.tsx (12 uncovered lines, 6 branches) so that the new visit server page permission checks are tested.",
      "acceptanceCriteria": [
        "Test file created at src/app/school/[udise]/visit/new/page.test.tsx",
        "~4 tests covering: no session -> redirect, no PM features -> redirect, no school access -> redirect, all checks pass -> renders NewVisitForm",
        "Mock: next-auth, @/lib/auth, next/navigation, @/lib/permissions (getUserPermission, getFeatureAccess, canAccessSchool)",
        "Mock NewVisitForm as stub component",
        "Params: Promise.resolve({ udise: '12345' })",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 20,
      "passes": true,
      "notes": "5 tests added. Covers: no session redirect, no email redirect, no visit edit access redirect, no school access redirect to /school/{udise}, all checks pass renders NewVisitForm with correct udise prop. Uses server component pattern from US-016. All 845 tests pass across 57 files."
    },
    {
      "id": "US-021",
      "title": "Add unit tests for visits/page.tsx (visit list)",
      "description": "As a developer, I want unit tests for src/app/visits/page.tsx (13 uncovered lines, 14 branches) so that the visit list server page is tested.",
      "acceptanceCriteria": [
        "Test file created at src/app/visits/page.test.tsx",
        "~6 tests covering: no session -> redirect, no PM features -> redirect, visit list with in-progress and completed visits, visit filtering by status, empty state (no visits), admin sees all visits vs PM sees own",
        "All 14 branches covered — high branch count needs careful testing of conditional rendering",
        "Mock: next-auth, @/lib/auth, next/navigation, @/lib/permissions, @/lib/db (query), next/link",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 21,
      "passes": true,
      "notes": "9 tests added. Covers: no session redirect, no email redirect, no visits canView redirect to /dashboard, in-progress visits with Continue links, completed visits with View links, both sections together, empty state with dashboard link, school_name fallback to school_code, SQL query verification (pm_email param). Uses server component pattern from US-016. All 854 tests pass across 58 files."
    },
    {
      "id": "US-022",
      "title": "Add unit tests for visits/[id]/page.tsx (visit detail)",
      "description": "As a developer, I want unit tests for src/app/visits/[id]/page.tsx (21 uncovered lines, 36 branches) so that the visit detail server page is tested.",
      "acceptanceCriteria": [
        "Test file created at src/app/visits/[id]/page.test.tsx",
        "~8 tests covering: no session -> redirect, no PM features -> redirect, visit not found -> notFound, ownership check (PM can only view own visits, admin can view any), section progress calculation, ended visit shows end time, section links render, EndVisitButton renders for active visits",
        "All 36 branches covered — high branch count from conditional section rendering",
        "Mock: next-auth, @/lib/auth, next/navigation (redirect + notFound), @/lib/permissions, @/lib/db (query), next/link",
        "Mock EndVisitButton as stub component",
        "Params: Promise.resolve({ id: '1' })",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 22,
      "passes": true,
      "notes": "27 tests added. Covers: no session redirect, no email redirect, no canView redirect to /dashboard, visit not found message, PM ownership check (non-owner sees 'no access'), admin can view any visit, visit header (school name, fallback to school_code, visit date, started/ended timestamps), status badges (In Progress, Ended, Completed), all 6 visit sections with names and links, progress bar (0/6, 2/6, 6/6), section completion logic (principalMeeting, leadershipMeetings, classroomObservations length, studentDiscussions groupDiscussions OR individualDiscussions, staffMeetings teamMeeting, teacherFeedback OR issueLog), EndVisitButton rendering (active visit only, not for ended/completed), ended confirmation (ended but not completed only), Back to Dashboard link, query verification (v.id=$1). All 881 tests pass across 59 files."
    },
    {
      "id": "US-023",
      "title": "Add unit tests for dashboard/page.tsx",
      "description": "As a developer, I want unit tests for src/app/dashboard/page.tsx (65 uncovered lines, 82 branches) so that the main dashboard server page is fully tested. This is the most complex page in the app.",
      "acceptanceCriteria": [
        "Test file created at src/app/dashboard/page.test.tsx",
        "~15 tests covering: no session -> redirect, passcode user -> redirect to school page, user with no permission -> 'no access' message, user with no program_ids (non-admin) -> 'program required' message, single-school user (level 1, 1 school) -> redirect to school page, multi-school user -> renders school list, admin user -> renders all features, PM user -> renders visit stats + 'Start Visit' links, search functionality, pagination, school count display, NVS student count per school, empty search results",
        "All 82 branches covered — extensive permission/level/role matrix",
        "Mock: next-auth, @/lib/auth, next/navigation, @/lib/permissions (getAccessibleSchoolCodes, getUserPermission, getProgramContextSync, getFeatureAccess), @/lib/db (query — called 4+ times, chain .mockResolvedValueOnce()), next/link",
        "Mock child components: SchoolSearch, StudentSearch, SchoolCard, Pagination",
        "Test the permission matrix (levels 1-4) x (roles: teacher, PM, admin) x (program combos)",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 23,
      "passes": true,
      "notes": "42 tests added. Covers: auth redirects (no session, no email, passcode user), no permission message, no program message, single-school redirect (with/without search), permission level subtitles (admin/level 3/level 2 regions/level 1 school count), admin link (level 4 only), PM nav links (Visits), PM stats cards (Total Visits, Open Issues), search components (StudentSearch, SchoolSearch with defaultValue), school cards (correct props, Start Visit for PM, showRegion toggle), grade counts integration, recent visits table (completed+in-progress, school_name fallback, View/Continue links, empty visits, non-PM), empty state (no search/search-specific), pagination (correct props, empty search, page clamping), My Schools heading for PM, multiple school cards, header elements (h1 Schools, email, sign out), query verification (search ILIKE, code ANY filter, grade counts params, empty schools skip), code+search combined filter, empty school codes early return."
    },
    {
      "id": "US-024",
      "title": "Add unit tests for school/[udise]/page.tsx",
      "description": "As a developer, I want unit tests for src/app/school/[udise]/page.tsx (76 uncovered lines, 71 branches) so that the school roster and tabs server page is fully tested. Second most complex page.",
      "acceptanceCriteria": [
        "Test file created at src/app/school/[udise]/page.test.tsx",
        "~18 tests covering: no session -> redirect, school not found -> notFound, passcode user access (own school only, other school -> redirect), Google user permission matrix (levels 1-4), feature tab gating (non-admin only sees Enrollment tab), NVS stats display, grade filter rendering, student data issues display, canEdit propagation to child components, empty student list",
        "All 71 branches covered — permission matrix + feature gating + data display",
        "Mock: next-auth, @/lib/auth, next/navigation (redirect + notFound), @/lib/permissions (getUserPermission, getProgramContextSync, getFeatureAccess), @/lib/db (query — called 4+ times), @/lib/school-student-list-data-issues (processStudents), @/lib/constants, next/link",
        "Mock child components: StudentTable, PageHeader, StatCard, SchoolTabs, CurriculumTab, PerformanceTab, VisitsTab",
        "Params: Promise.resolve({ udise: '12345' })",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 24,
      "passes": true,
      "notes": "45 tests added. Covers: auth redirect (no session), notFound (no school), passcode user access (own school ok, wrong school denied with Return to login link), Google user permissions (no permission denied, level 1 matching/non-matching school_codes, level 2 matching/non-matching region incl null region, level 3 all-schools, level 4 admin), no program access message, PageHeader props (title, subtitle with/without UDISE, backHref for multi/single school, Google email vs passcode School label), tab visibility (all tabs for full access, enrollment-only for restricted), CurriculumTab props (schoolCode, schoolName, canEdit), PerformanceTab props (udise_code fallback to code), VisitsTab props (schoolCode), NVS student stats (grade breakdown, excludes dropouts, excludes non-NVS, null grade handling), StudentTable props (active/dropout split, canEdit, isAdmin, isPasscodeUser, userProgramIds, grades, batches, nvsStreams), data issues banner (multiple issues, single issue singular text, no issues hidden), NVS streams extraction (sorted, deduplicated, null metadata handling), hasMultipleSchools logic (level >=2, school_codes length), query verification (school by udise, students by school id, batches by program_id=64), mentorship tab coming soon. Uses vi.resetAllMocks() with sentinel re-establishment pattern."
    },
    {
      "id": "US-025",
      "title": "Add unit tests for layout.tsx",
      "description": "As a developer, I want unit tests for src/app/layout.tsx (4 uncovered lines) so that the root layout is tested.",
      "acceptanceCriteria": [
        "Test file created at src/app/layout.test.tsx",
        "~1 test covering: renders children wrapped in Providers, metadata export is correct",
        "Mock next/font/google (return objects with className and variable properties)",
        "Mock Providers as passthrough component",
        "Mock CSS import",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 25,
      "passes": true,
      "notes": "3 tests added. Covers: rendering children inside Providers (RTL render with mock Providers stub), JSX tree inspection for font variables (--font-geist-sans, --font-geist-mono) and antialiased class on body + lang='en' and suppressHydrationWarning on html (via direct function call since jsdom flattens nested html/body), metadata export (title, description). Mocks: next/font/google (Geist, Geist_Mono return variable property), ./globals.css (empty), @/components/Providers (passthrough div with data-testid)."
    },
    {
      "id": "US-026",
      "title": "Verify Phase 4 coverage (~98%)",
      "description": "As a developer, I want to verify that Phase 4 tests (server pages) bring coverage to ~98%. The 90% threshold should be crossed during this phase.",
      "acceptanceCriteria": [
        "Run npm run test:unit:coverage — all tests pass",
        "Line coverage is >=90% (target: 98.2%) — 90% threshold crossed",
        "Commit updated unit-coverage/coverage-summary.json",
        "Build passes (npm run build)",
        "Lint passes (npm run lint)"
      ],
      "priority": 26,
      "passes": true,
      "notes": "971 tests pass across 62 files. Line coverage: 97.55% (>= 90% threshold). Statement coverage: 97.18%. Branch coverage: 93.94%. Functions: 96.11%. Phase 4 added ~12% coverage from 10 server page test files. Lint clean on all Phase 4 test files. Build has pre-existing e2e/helpers/db.ts type error (not related)."
    },
    {
      "id": "US-027",
      "title": "Close coverage gaps in student/[id]/route.ts",
      "description": "As a developer, I want to close the 7 uncovered lines and 3 uncovered branches in src/app/api/student/[id]/route.ts (currently 86.27% lines).",
      "acceptanceCriteria": [
        "Add ~4 tests to existing src/app/api/student/[id]/route.test.ts",
        "Cover: student update HTTP failure path, batch update failure path, batch success response parsing",
        "File reaches 100% line coverage",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 27,
      "passes": true,
      "notes": "3 tests added (11 total). Covers: empty ID param returns 400, student update HTTP failure (404) returns 400 with error text, batch update failure returns 200 with warnings. File reaches 100% line, branch, function, and statement coverage."
    },
    {
      "id": "US-028",
      "title": "Close coverage gaps in QuizAnalyticsSection.tsx",
      "description": "As a developer, I want to close the 3 uncovered lines and 2 uncovered branches in src/components/QuizAnalyticsSection.tsx (currently 92.85% lines).",
      "acceptanceCriteria": [
        "Add ~2 tests to existing src/components/QuizAnalyticsSection.test.tsx",
        "Cover: edge UI states (loading + empty data permutations)",
        "File reaches 100% line coverage",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 28,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-029",
      "title": "Close coverage gaps in StudentTable.tsx",
      "description": "As a developer, I want to close the 3 uncovered lines and 6 uncovered branches in src/components/StudentTable.tsx (currently 96.15% lines).",
      "acceptanceCriteria": [
        "Add ~3 tests to existing src/components/StudentTable.test.tsx",
        "Cover: conditional rendering edge cases (NVS filtering, dropout display variations)",
        "File reaches 100% line coverage",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 29,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-030",
      "title": "Close coverage gaps in permissions.ts",
      "description": "As a developer, I want to close the 2 uncovered lines and 5 uncovered branches in src/lib/permissions.ts (currently 97.01% lines).",
      "acceptanceCriteria": [
        "Add ~3 tests to existing src/lib/permissions.test.ts",
        "Cover: uncovered permission edge cases (specific level/role/program combinations)",
        "File reaches 100% line coverage",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 30,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-031",
      "title": "Close coverage gaps in NewVisitForm.tsx",
      "description": "As a developer, I want to close the 2 uncovered lines and 9 uncovered branches in src/components/visits/NewVisitForm.tsx (currently 94.11% lines, 75% branches).",
      "acceptanceCriteria": [
        "Add ~4 tests to existing src/components/visits/NewVisitForm.test.tsx",
        "Cover: GPS error paths, accuracy warning thresholds (100-500m range), all branch gaps",
        "File reaches >=95% line coverage and >=90% branch coverage",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 31,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-032",
      "title": "Close coverage gaps in curriculum/chapters/route.ts",
      "description": "As a developer, I want to close the 2 uncovered lines and 3 uncovered branches in src/app/api/curriculum/chapters/route.ts (currently 94.73% lines).",
      "acceptanceCriteria": [
        "Add ~2 tests to existing src/app/api/curriculum/chapters/route.test.ts",
        "Cover: missing topic/subject edge cases",
        "File reaches 100% line coverage",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 32,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-033",
      "title": "Close coverage gap in EditStudentModal.tsx",
      "description": "As a developer, I want to close the 1 uncovered line and 1 uncovered branch in src/components/EditStudentModal.tsx (currently 98.86% lines).",
      "acceptanceCriteria": [
        "Add ~1 test to existing src/components/EditStudentModal.test.tsx",
        "Cover: single uncovered branch",
        "File reaches 100% line coverage",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 33,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-034",
      "title": "Close coverage gaps in StudentSearch.tsx",
      "description": "As a developer, I want to close the 1 uncovered line and 5 uncovered branches in src/components/StudentSearch.tsx (currently 96.15% lines, 78.26% branches).",
      "acceptanceCriteria": [
        "Add ~3 tests to existing src/components/StudentSearch.test.tsx",
        "Cover: search edge cases (empty results, special characters, branch gaps)",
        "File reaches 100% line coverage and >=90% branch coverage",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 34,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-035",
      "title": "Close coverage gaps in EndVisitButton.tsx",
      "description": "As a developer, I want to close the 1 uncovered line and 5 uncovered branches in src/components/visits/EndVisitButton.tsx (currently 96.66% lines, 84.37% branches).",
      "acceptanceCriteria": [
        "Add ~3 tests to existing src/components/visits/EndVisitButton.test.tsx",
        "Cover: GPS accuracy edge cases, already-ended visit handling",
        "File reaches 100% line coverage and >=90% branch coverage",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 35,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-036",
      "title": "Close coverage gaps in geolocation.ts",
      "description": "As a developer, I want to close the 1 uncovered line and 4 uncovered branches in src/lib/geolocation.ts (currently 98.24% lines, 89.74% branches).",
      "acceptanceCriteria": [
        "Add ~2 tests to existing src/lib/geolocation.test.ts",
        "Cover: uncovered timeout/error code branch",
        "File reaches 100% line coverage and >=95% branch coverage",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 36,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-037",
      "title": "Close coverage gap in batches/[id]/route.ts",
      "description": "As a developer, I want to close the 1 uncovered line and 1 uncovered branch in src/app/api/batches/[id]/route.ts (currently 96.77% lines).",
      "acceptanceCriteria": [
        "Add ~1 test to existing src/app/api/batches/[id]/route.test.ts",
        "Cover: single uncovered line (likely error path)",
        "File reaches 100% line coverage",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 37,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-038",
      "title": "Verify Phase 5 coverage (>=95%)",
      "description": "As a developer, I want to verify that Phase 5 gap-closing tests bring coverage near maximum.",
      "acceptanceCriteria": [
        "Run npm run test:unit:coverage — all tests pass",
        "Line coverage is >=95% (target: 99.4%)",
        "Commit updated unit-coverage/coverage-summary.json",
        "Build passes (npm run build)",
        "Lint passes (npm run lint)"
      ],
      "priority": 38,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-039",
      "title": "Add unit tests for proxy.ts (middleware)",
      "description": "As a developer, I want unit tests for src/proxy.ts (10 uncovered lines, 10 branches) so that the auth middleware is tested.",
      "acceptanceCriteria": [
        "Test file created at src/proxy.test.ts",
        "~5 tests covering: public route passthrough (no token needed), public route with token -> redirect to dashboard, protected route without token -> redirect to login, protected route with token -> passthrough, config matcher export",
        "Mock next-auth/jwt (getToken)",
        "Mock NextRequest and NextResponse from next/server",
        "Check the actual export name — function is exported as proxy or middleware",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 39,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-040",
      "title": "Add unit test for constants.ts",
      "description": "As a developer, I want a unit test for src/lib/constants.ts (1 uncovered line) to verify the constant value.",
      "acceptanceCriteria": [
        "Test file created at src/lib/constants.test.ts",
        "1 test: assert JNV_NVS_PROGRAM_ID === 64",
        "Tests pass (npm run test)",
        "Lint passes (npm run lint)",
        "Build passes (npm run build)"
      ],
      "priority": 40,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-041",
      "title": "Final coverage verification and cleanup",
      "description": "As a developer, I want to verify that all phases are complete, all tests pass, and coverage meets the 90%+ target.",
      "acceptanceCriteria": [
        "Run npm run test:unit:coverage — ALL tests pass (expected: ~800 tests)",
        "Line coverage is >=90% (target: ~100%)",
        "Build passes (npm run build) with no regressions",
        "Lint passes (npm run lint)",
        "Commit final unit-coverage/coverage-summary.json",
        "No test files have been accidentally excluded from coverage"
      ],
      "priority": 41,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-042",
      "title": "Review all changes and document findings",
      "description": "As a developer, I want to review all changes made during the unit test coverage push and document findings for the team.",
      "acceptanceCriteria": [
        "Use explore agents to understand the current state of all modified/new test files",
        "Review git diff to see all changes made across all phases",
        "Verify no unintended side effects or missing pieces",
        "Create ralph/unit-test-coverage-90-review.txt with concise findings (under 50 lines)",
        "Review file summarizes: phases completed, total tests added, final coverage numbers, any files that resisted testing, recommendations"
      ],
      "priority": 42,
      "passes": false,
      "notes": ""
    }
  ]
}
