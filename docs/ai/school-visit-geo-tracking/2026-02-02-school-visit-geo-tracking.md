# School Visit Geo-Tracking Feature

**Date:** 2026-02-02
**Status:** Planning
**Author:** AI-assisted planning session
**Last updated:** 2026-02-11 (moved implementation/testing phases to a separate file)

---

## 1. Background

### Current School Visit Feature

The school visit feature allows Program Managers (PMs) to document their visits to JNV schools. Currently:

- Visits are stored in `lms_pm_school_visits` table
- Visit data is stored as JSONB with 7 top-level sections/keys:
  - Principal Meeting (implemented)
  - Leadership Meetings (placeholder)
  - Classroom Observations (placeholder)
  - Student Discussions (placeholder)
  - Staff Meetings (placeholder)
  - Teacher Feedback (placeholder)
  - Issue Log (placeholder)

### Current Schema

Source: `../db-service/priv/repo/migrations/20251211085727_create_lms_pm_school_visits_table.exs`

```sql
CREATE TABLE lms_pm_school_visits (
  id SERIAL PRIMARY KEY,
  school_code VARCHAR(20) NOT NULL,
  pm_email VARCHAR(255) NOT NULL,
  visit_date DATE NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'in_progress',
  data JSONB NOT NULL DEFAULT '{}',
  inserted_at TIMESTAMP NOT NULL DEFAULT NOW(),  -- Ecto convention (not created_at)
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
  CONSTRAINT status_constraint CHECK (status IN ('in_progress', 'completed'))
);

-- Indexes (names are auto-generated by Ecto)
CREATE INDEX ON lms_pm_school_visits(school_code);
CREATE INDEX ON lms_pm_school_visits(pm_email);
CREATE INDEX ON lms_pm_school_visits(visit_date);
CREATE INDEX ON lms_pm_school_visits(status);
CREATE INDEX ON lms_pm_school_visits(school_code, visit_date);
CREATE INDEX ON lms_pm_school_visits(pm_email, visit_date);
```

### Known Issues to Resolve Before Implementation

**0. Geo-tracking schema migration does not exist yet (MUST ADD IN DB-SERVICE)**
- The `lms_pm_school_visits` table currently only has the base columns from the db-service migration `20251211085727_create_lms_pm_school_visits_table.exs`.
- The geo-tracking columns proposed in this doc (`start_lat`, `start_lng`, `start_accuracy`, `ended_at`, `end_lat`, `end_lng`, `end_accuracy`) do **not** exist in db-service yet.
- **Action:** Create and ship a new db-service migration to add these columns + the `ended_at` index before LMS starts writing geo data.

**1. Legacy DB column drift (created_at vs inserted_at)**
- Canonical DB schema (db-service migration) uses: `inserted_at` / `updated_at` (Ecto convention).
- Some environments may have an older table with `created_at` instead of `inserted_at`.
- Impact: LMS code queries `inserted_at`, so older schemas can break runtime reads.
- **Action:** If you find `created_at` in any environment DB, fix it via a one-time DB change (migration or manual SQL): `ALTER TABLE lms_pm_school_visits RENAME COLUMN created_at TO inserted_at;`
- Note: We are deprecating `scripts/setup-pm-tables.ts` and won’t rely on it for schema fixes going forward.

**2. Timestamp / timezone choice (DECIDED: KEEP AS-IS FOR NOW)**
- Canonical schema (db-service) uses `TIMESTAMP` (no timezone) for `inserted_at` / `updated_at` via Ecto `timestamps()`.
- Decision: **do not migrate** existing timestamps to `TIMESTAMPTZ` right now.
- New geo-tracking timestamp (`ended_at`) will also use `TIMESTAMP` for consistency.
  - Convention: store timestamps as **UTC** and display them in local time (e.g. Asia/Kolkata) in UI.
  - Implementation tip: do not "assume" the DB/server timezone is UTC; enforce UTC explicitly when writing timestamps (see "Timestamp rules" below).

**3. "Complete Visit" flow mismatch in current LMS code (FIX THIS OR PAUSE COMPLETION)**
- **What the UI does today:**
  - On the visit detail page (`src/app/visits/[id]/page.tsx`), the “Complete Visit” button submits an HTML `<form>` to:
    - `POST /api/pm/visits/{id}`
    - It includes a hidden field: `action=complete`.
- **What the API supports today:**
  - The API file for that same path is `src/app/api/pm/visits/[id]/route.ts`.
  - That file exports `GET`, `PATCH`, and `PUT` handlers — **there is no `POST` handler**.
  - So a browser form POST to `/api/pm/visits/{id}` will not be handled by the route code (and will fail).
  - Also: HTML forms send `application/x-www-form-urlencoded` (or `multipart/form-data`), but the current completion code expects JSON (`await request.json()`), so even a naive POST handler would need to parse form data.
- **Why this matters:**
  - PMs will click “Complete Visit” and it won’t work reliably; this creates confusion during pilots.
  - Geo-tracking (start/end GPS) is independent of completion and should not be blocked by it.
- **Ways to fix (choose later, Phase 2+):**
  1. Update the UI to call `PUT /api/pm/visits/{id}` with JSON `{ "action": "complete" }` via `fetch` (no HTML form).
  2. Update the API to also accept `POST` form submits (parse `request.formData()`), then internally call the same completion logic.
  3. Move completion into a dedicated endpoint like `POST /api/pm/visits/{id}/complete` to avoid method/content-type ambiguity.
- **Phase 1 decision (recommended):** Temporarily hide/disable “Complete visit” in the UI until completion rules and section pages are aligned.

**4. Completion validation blocks real usage (PHASE 1 SHOULD NOT DEPEND ON COMPLETION)**
- The completion endpoint validates that multiple sections are “filled” (leadership meetings, classroom observations, staff team meeting, etc.).
- But most of those sections are not implemented as actual UI pages yet (they’re linked as placeholders), so PMs can’t realistically satisfy the completion criteria.
- Also, once a visit is `status='completed'`, the API blocks updates — which would lock PMs out of finishing forms later.
- **Phase 1 decision:** Geo-tracking must support:
  - Start visit (create + start GPS)
  - End visit (ended_at + end GPS)
  - …even if the visit is still `status='in_progress'` and sections are incomplete.

### Current JSONB Data Structure

```typescript
{
  principalMeeting: {
    syllabusStatus: string,
    examPerformance: string,
    programUpdates: string,
    potentialToppers: string,
    supportRequired: string,
    classTimingConfirmed: boolean,
    classroomAvailable: boolean,
    resourceAccess: {
      tablets: boolean,
      printers: boolean,
      smartBoards: boolean
    },
    notes: string
  } | null,
  leadershipMeetings: null,
  classroomObservations: [],
  studentDiscussions: {
    groupDiscussions: [],
    individualDiscussions: []
  },
  staffMeetings: {
    individualMeetings: [],
    teamMeeting: null
  },
  teacherFeedback: [],
  issueLog: []
}
```

---

## 2. New Requirements

### Geo-Tracking for Visits

**Scope:** Visit-level geo-tracking (start + end location).

> **Per-action-point tracking** (GPS per principal meeting, classroom observation, etc.) is planned separately. See `2026-02-02-visit-action-points.md`.

1. **Visit-level tracking**
   - Start: GPS location captured when PM creates the visit (stored alongside `inserted_at` which serves as the start timestamp)
   - End: timestamp + GPS location (when PM leaves school)

2. **Platform**
   - PMs will use mobile app or mobile browser
   - Must work on Android and iOS

### Definitions (important for clarity)

These words will be used consistently:

- **Start Visit**: create a visit record and capture start GPS. The existing `inserted_at` column serves as the start timestamp (no separate `started_at` column — creating a visit and starting it are the same action).
- **End Visit**: capture end GPS + end time (`ended_at`, `end_lat`, `end_lng`, `end_accuracy`).
- **Complete Visit**: mark the visit as finalized (usually `status='completed'`) after form checks (can be Phase 2 / later).

Phase 1 rule:
- A visit can be **ended** (has `ended_at`) but still remain `status='in_progress'`.
- For Phase 1, we treat `ended_at IS NOT NULL` as "ended".

### Phase 1 rules (what we will enforce now)

- GPS is **required** to start a visit and to end a visit.
- End visit should **not** block on missing/empty form sections.
- `inserted_at` (start time) is set server-side automatically via `DEFAULT NOW()`.
- `ended_at` should use **server-side time** in UTC (not device time).
- `visit_date` should be set **server-side** using `(NOW() AT TIME ZONE 'Asia/Kolkata')::date` to avoid client timezone drift.

### Intentionally out of scope (Phase 1)

- **No distance check against school location.** We don't have school GPS coordinates in the DB right now. Phase 1 is an audit trail only — it records where the PM was, but does not enforce that they were at the school. Adding school coordinates + radius check is a future improvement.
- **No detailed GPS permission help UI.** If the browser blocks GPS, we show a basic error message. Step-by-step instructions (e.g., "Go to Settings > Safari > Location") will be added after the MVP is out and we get user feedback on what's actually confusing.

### GPS acceptance criteria (Phase 1)

To accept a GPS reading, the API should require:
- `lat`, `lng`, `accuracy` must be present.
- `lat` must be between `-90` and `90`; `lng` must be between `-180` and `180`.
- `accuracy` must be a number in meters.

Accuracy policy (DECIDED):
- **Accept** readings with `accuracy <= 100m`.
- **Warn** when `accuracy` is between `100m` and `500m` (allow but show a warning).
- **Reject** readings with `accuracy > 500m` and ask the PM to retry (move outside / wait).

### Timestamp rules (Phase 1)

**Confirmed:** Production DB server timezone is UTC (`SHOW timezone;` returns `UTC`).

We are storing `TIMESTAMP` (no timezone). To avoid timezone bugs:
- Store all visit/action timestamps as **UTC**.
- The existing `inserted_at DEFAULT NOW()` is safe because the DB server is UTC.
- For `ended_at`, also use `NOW()` (server-side) rather than client time.
- For `visit_date`, derive from server time converted to IST: `(NOW() AT TIME ZONE 'Asia/Kolkata')::date`.
- UI should display times in local time (Asia/Kolkata).

---

## 3. Proposed Schema Changes

### 3.1 Update `lms_pm_school_visits` Table

Add columns for visit-level geo-tracking:

```sql
-- Add geo-tracking columns (TIMESTAMP for consistency with existing schema)
-- Note: no `started_at` column — we use the existing `inserted_at` as the start timestamp.
ALTER TABLE lms_pm_school_visits
  ADD COLUMN start_lat DECIMAL(10, 8),
  ADD COLUMN start_lng DECIMAL(11, 8),
  ADD COLUMN start_accuracy DECIMAL(10, 2),  -- GPS accuracy in meters
  ADD COLUMN ended_at TIMESTAMP,
  ADD COLUMN end_lat DECIMAL(10, 8),
  ADD COLUMN end_lng DECIMAL(11, 8),
  ADD COLUMN end_accuracy DECIMAL(10, 2);    -- GPS accuracy in meters

-- Index for querying un-ended or recently ended visits
CREATE INDEX ON lms_pm_school_visits(ended_at);

-- (Optional) light validation checks can be added later:
-- - lat between -90..90, lng between -180..180
-- For Phase 1, keep it simple and validate in API code only.
```

---

## 4. Updated Data Model

```
lms_pm_school_visits
+-- id (PK)
+-- school_code -> school.code
+-- pm_email
+-- visit_date
+-- status: 'in_progress' | 'completed'
|
+-- # EXISTING (doubles as start timestamp)
+-- inserted_at (TIMESTAMP, NOT NULL, DEFAULT NOW())
|
+-- # NEW: Start GPS (captured when visit is created)
+-- start_lat, start_lng, start_accuracy (DECIMAL)
|
+-- # NEW: End timestamp + GPS (captured when PM ends visit)
+-- ended_at (TIMESTAMP)
+-- end_lat, end_lng, end_accuracy (DECIMAL)
|
+-- data (JSONB) <- Keep for backward compatibility
+-- updated_at (TIMESTAMP)

See also: 2026-02-02-visit-action-points.md (per-action tracking, future)
```

---

## 5. User Flow

```
+-------------------------------------------------------------+
| PM opens app at school location                              |
+-------------------------------------------------------------+
                              |
                              v
+-------------------------------------------------------------+
| Taps "Start Visit"                                           |
| -> Browser requests GPS (watchPosition until accurate)       |
| -> Creates visit record (inserted_at = start time)           |
| -> Stores start_lat/lng/accuracy                             |
| -> Visit status stays 'in_progress'                          |
+-------------------------------------------------------------+
                              |
                              v
+-------------------------------------------------------------+
| PM fills in visit forms (principal meeting, etc.)            |
+-------------------------------------------------------------+
                              |
                              v
+-------------------------------------------------------------+
| Taps "End Visit"                                             |
| -> Browser requests GPS again                                |
| -> Records: ended_at + end_lat/lng/accuracy                  |
| -> Does NOT mark status 'completed' (Phase 1)                |
+-------------------------------------------------------------+
```

**Edge cases:**
- If PM's phone dies mid-visit, they can end the visit later from any device (GPS will be from their current location at that time, not the school — this is acceptable for Phase 1).
- Admins can end a visit on behalf of a PM.
- No auto-expiry for un-ended visits. **Post-MVP:** add a "stale visits" query to the admin dashboard (e.g., visits older than 48 hours with no `ended_at`) so admins can spot and close them.

---

## 6. API Design

### Visit Lifecycle

| Method | Route | Purpose |
|--------|-------|---------|
| `POST` | `/api/pm/visits` | Start visit (create + record start GPS) |
| `POST` | `/api/pm/visits/[id]/end` | End visit + record end location |
| `GET` | `/api/pm/visits/[id]` | Get visit details |

**Phase 1 note:** `POST /api/pm/visits/[id]/end` should only set `ended_at` + end location. It should **not** block on missing form sections. Status updates can be added later once all sections exist.

**Server time:** `inserted_at` is set automatically by the DB (`DEFAULT NOW()`). Set `ended_at` using server-side `NOW()` (don't trust client clocks). Also set `updated_at = NOW()` in the end-visit query.

**Phase 1 validation:**
- Start visit:
  - require a GPS reading (lat/lng/accuracy) in the request body
  - reject if GPS is missing or invalid (see accuracy policy above)
- End visit:
  - require a GPS reading (lat/lng/accuracy) in the request body
  - reject if visit does not exist or is not owned by the PM
  - **idempotent**: if `ended_at` is already set, return success without changes
  - **admin override**: admins (level 4) can end any visit

**No duplicate visit constraint (Phase 1):** Multiple visits per PM per school per day are allowed. We'll revisit this after the MVP if needed.

**Visibility / privacy (recommended default):**
- Treat GPS as sensitive data.
- Only the **visit owner PM** and **admins** can see exact `lat/lng` fields.
- Other roles (if/when they can view visits) should only see:
  - `inserted_at` (start time), `ended_at`
  - maybe `start_accuracy` / `end_accuracy` (optional)
- UI: show start/end **time** by default; show exact coordinates only to admins/owner when needed.
- Also: do not log raw `lat/lng` values in server logs.

### Status display (UI / reporting)

For Phase 1, show the visit state using these simple rules:
- **Started**: visit exists (`inserted_at` is always set)
- **Ended**: `ended_at` is set
- **Completed**: `status = 'completed'` (may be unused/disabled in Phase 1)

> Action point CRUD and lifecycle APIs are documented in `2026-02-02-visit-action-points.md`.

---

## 7. Implementation & Testing Plan

Detailed implementation phases + testing checklists live in:
- `2026-02-02-school-visit-geo-tracking-implementation-and-testing-plan.md`

---

## 8. Decisions Log

| # | Topic | Decision |
|---|-------|----------|
| 1 | `started_at` vs `inserted_at` | Use `inserted_at` only. Creating a visit = starting it. No separate `started_at` column. |
| 2 | GPS accuracy threshold | Accept <= 100m, warn 100-500m, reject > 500m |
| 3 | Duplicate visits | Allowed. No constraint for Phase 1. Revisit after MVP. |
| 4 | Distance check (PM vs school) | Intentionally skipped. We don't have school GPS coordinates. Phase 1 is audit-trail only. Will add later. |
| 5 | Visibility | Only visit owner PM + admins see exact lat/lng. |
| 6 | Admin powers | Admins can end a visit on behalf of a PM. |
| 7 | Phone dies mid-visit | PM can end the visit later from any device. No auto-expiry. |
| 8 | GPS help UI (settings instructions) | Deferred to post-MVP. Show basic error message for now. |
| 9 | Phase 2 data migration | See `2026-02-02-visit-action-points.md`. |
| 10 | DB server timezone | Confirmed UTC via `SHOW timezone;`. `DEFAULT NOW()` on `inserted_at` is safe. |
| 11 | `visit_date` derivation | Server-side: `(NOW() AT TIME ZONE 'Asia/Kolkata')::date`. Client no longer sends it. |
| 12 | GPS timeout | 60 seconds (up from 30). Buildings can be slow. PM can retry with a tap. |
| 13 | `ended_at` index | Added. Useful for querying un-ended or recently ended visits. |
| 14 | HTTPS for Geolocation | Geolocation API requires HTTPS or localhost. Utility checks and throws a clear error on HTTP. |
| 15 | watchPosition cleanup | `getAccurateLocation()` returns `{ promise, cancel }` so component can cancel on unmount or user tap. |
| 16 | Ghost visits | No auto-expiry for Phase 1. Post-MVP: admin dashboard query for stale visits (>48h, no `ended_at`). |

## 9. Open Questions

**Still open:**
1. **Retention:** keep geo data forever, or purge after X months?
2. **Offline support:** do we need offline capture and later sync?
